<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Conjugation Dojo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect"             function toHiragana(romaji) {
                let hiragana = '';
                let i = 0;
                // Refined romaji cleaning
                romaji = romaji.toLowerCase()
                               .replace(/n'/, 'n')
                               .replace(/tchi/g, 'cchi'); // Handle edge case like 'matcha'
                while (i < romaji.length) {
                    // Handle double consonants (sokuon)
                    if (i + 1 < romaji.length && romaji[i] !== 'n' && romaji[i] === romaji[i+1]) {
                        hiragana += '„Å£';
                        i++;
                        continue;
                    }
                    let found = false;
                    // Check for 3-character kana
                    if (i + 2 < romaji.length) {
                        const threeChar = romaji.substring(i, i + 3);
                        if (wanakana[threeChar]) {
                            hiragana += wanakana[threeChar];
                            i += 3;
                            found = true;
                        }
                    }
                    // Check for 2-character kana
                    if (!found && i + 1 < romaji.length) {
                        const twoChar = romaji.substring(i, i + 2);
                        if (wanakana[twoChar]) {
                            hiragana += wanakana[twoChar];
                            i += 2;
                            found = true;
                        }
                    }
                    // Handle 1-character kana
                    if (!found) {
                        const oneChar = romaji[i];
                        hiragana += wanakana[oneChar] || oneChar;
                        i += 1;
                    }
                }
                return hiragana;
            }tps://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        :root {
            --bg-color: #f0f4f8;
            --card-color: #ffffff;
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --correct-color: #16a34a;
            --incorrect-color: #dc2626;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border-color: #cbd5e1;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 90vh; 
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
        }
        main {
            background-color: var(--card-color);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
            padding: 2.5rem;
            text-align: center;
            max-height: 98vh; 
            overflow-y: auto;
        }
        h1 {
            color: var(--text-dark);
            font-size: 2rem;
            margin-bottom: 1.5rem;
        }
        .level-selector { margin-bottom: 1.5rem; }
        .level-selector label {
            color: var(--text-light);
            margin-right: 0.75rem;
        }
        .level-selector select {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1.1rem;
        }
        .card-panel, #introduction-panel {
            background: linear-gradient(135deg, var(--primary-color), #60a5fa);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            min-height: 180px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        #kana-display {
            font-size: 4rem;
            font-weight: 700;
            margin: 0;
        }
        #kanji-display, #form-display, #verb-type-display {
            font-size: 1.2rem;
            margin: 0.5rem 0 0;
        }
        #answer-input {
            width: 100%;
            padding: 1.2rem;
            font-size: 1.4rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.2s, background-color 0.2s;
            margin-bottom: 1.5rem;
        }
        #answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        #answer-input.correct {
            border-color: var(--correct-color);
            background-color: #f0fdf4;
        }
        #answer-input.incorrect {
            border-color: var(--incorrect-color);
            background-color: #fef2f2;
            animation: shake 0.5s ease-in-out;
        }
        button {
            width: 100%;
            padding: 1.1rem;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); }
        #check-button { background-color: var(--primary-color); }
        #check-button:hover { background-color: var(--primary-hover); }
        #next-button { background-color: var(--correct-color); }
        #next-button:hover { background-color: #15803d; }
        .feedback-area {
            min-height: 4rem;
            margin-top: 1.5rem;
        }
        #feedback-message { 
            font-size: 1.3rem;
            font-weight: bold; 
            transition: opacity 0.3s;
        }
        #feedback-message.correct { color: var(--correct-color); }
        #feedback-message.incorrect { color: var(--incorrect-color); }
        #correct-answer-display { 
            color: var(--text-light); 
            font-size: 1rem;
        }
        .progress-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            padding-top: 1.2rem;
            border-top: 1px solid #e2e8f0;
        }
        .progress-area p { 
            color: var(--text-light); 
            font-size: 1rem;
            margin: 0.2rem 0; 
        }
        .progress-area span { font-weight: bold; color: var(--text-dark); }
        #reset-button {
            background: none; border: none;
            color: var(--incorrect-color);
            cursor: pointer; font-weight: bold;
            padding: 0.5rem; font-size: 1rem;
        }
        .hidden { display: none !important; }

        #introduction-panel { text-align: left; }
        #introduction-panel h2 {
            font-size: 1.8rem; margin-bottom: 1rem;
            color: white; text-align: center;
        }
        #introduction-panel h3 {
            font-size: 1.3rem; margin-top: 1.5rem;
            margin-bottom: 0.5rem; color: white;
            text-align: left;
        }
        #introduction-panel p, #introduction-panel li {
            font-size: 1.1rem; line-height: 1.6;
            margin-bottom: 0.5rem; color: white;
        }
        #introduction-panel ul {
            list-style: disc; color: white;
            padding-left: 1.5rem; margin-top: 0.5rem;
        }
        #introduction-panel .intro-nav-buttons {
            display: flex; justify-content: space-between;
            gap: 1rem; margin-top: 1.5rem;
        }
        #introduction-panel .intro-nav-buttons button {
            flex: 1; background-color: rgba(255, 255, 255, 0.2);
        }
        #introduction-panel .intro-nav-buttons button:hover:not(:disabled) {
            background-color: rgba(255, 255, 255, 0.3);
        }
        #introduction-panel .intro-nav-buttons button:disabled {
            opacity: 0.5; cursor: not-allowed; transform: none;
        }
        #introduction-panel #start-practice-button {
            margin-top: 1.5rem;
            background-color: var(--correct-color);
        }
        #introduction-panel #start-practice-button:hover { background-color: #15803d; }

        #introduction-panel .grammar-example {
            background-color: rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--correct-color);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0 8px 8px 0;
        }
        #introduction-panel .grammar-example p {
            margin: 0.25rem 0;
            color: white;
        }
        #introduction-panel .grammar-example .jp {
            font-weight: bold;
            font-size: 1.2rem;
        }
        #introduction-panel .grammar-example .kana {
            font-size: 0.9rem;
            color: #e2e8f0;
        }
        #introduction-panel .grammar-example .en {
            font-size: 1rem;
            font-style: italic;
            color: #f1f5f9;
        }
    </style>
</head>
<body>

    <main id="app-container">
        <h1>Conjugation Dojo</h1>
        <div class="level-selector">
            <label for="topic-select">Topic:</label>
            <select id="topic-select"></select>
        </div>
        <div id="introduction-panel" class="hidden">
            <h2 id="intro-title"></h2>
            <div id="intro-sections-container"></div>
            <div class="intro-nav-buttons">
                <button id="prev-intro-slide-button" disabled>&larr; Previous</button>
                <button id="next-intro-slide-button">Next &rarr;</button>
            </div>
            <button id="start-practice-button" class="hidden">Start Practice</button>
        </div>
        <div class="card-panel">
            <p id="kana-display"></p>
            <p id="kanji-display"></p>
            <p id="form-display"></p>
            <p id="verb-type-display"></p>
        </div>
        <input type="text" id="answer-input" placeholder="Type Romaji here..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        <button id="check-button">Check</button>
        <button id="next-button" class="hidden">Next</button>
        <div class="feedback-area" aria-live="polite">
            <p id="feedback-message"></p>
            <p id="correct-answer-display"></p>
        </div>
        <div class="progress-area">
            <div>
                <p>Correct: <span id="correct-count">0</span></p>
                <p>Incorrect: <span id="incorrect-count">0</span></p>
            </div>
            <button id="reset-button">Reset Session</button>
        </div>
    </main>

    <script src="data.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Data loading check
            if (typeof japaneseVerbs === 'undefined' || typeof conjugationForms === 'undefined' || typeof japaneseGrammar === 'undefined') {
                document.getElementById('app-container').innerHTML = '<h1>Error</h1><p>Could not load necessary data. Please check your internet connection and refresh the page.</p>';
                return; // Stop the script from running further
            }

            const wanakana = {
                "a":"„ÅÇ", "i":"„ÅÑ", "u":"„ÅÜ", "e":"„Åà", "o":"„Åä", "ka":"„Åã", "ki":"„Åç", "ku":"„Åè", "ke":"„Åë", "ko":"„Åì", "sa":"„Åï", "shi":"„Åó", "su":"„Åô", "se":"„Åõ", "so":"„Åù", "ta":"„Åü", "chi":"„Å°", "tsu":"„Å§", "te":"„Å¶", "to":"„Å®", "na":"„Å™", "ni":"„Å´", "nu":"„Å¨", "ne":"„Å≠", "no":"„ÅÆ", "ha":"„ÅØ", "hi":"„Å≤", "fu":"„Åµ", "he":"„Å∏", "ho":"„Åª", "ma":"„Åæ", "mi":"„Åø", "mu":"„ÇÄ", "me":"„ÇÅ", "mo":"„ÇÇ", "ya":"„ÇÑ", "yu":"„ÇÜ", "yo":"„Çà", "ra":"„Çâ", "ri":"„Çä", "ru":"„Çã", "re":"„Çå", "ro":"„Çç", "wa":"„Çè", "wo":"„Çí", "n":"„Çì", "ga":"„Åå", "gi":"„Åé", "gu":"„Åê", "ge":"„Åí", "go":"„Åî", "za":"„Åñ", "ji":"„Åò", "zu":"„Åö", "ze":"„Åú", "zo":"„Åû", "da":"„Å†", "di":"„Å¢", "du":"„Å•", "de":"„Åß", "do":"„Å©", "ba":"„Å∞", "bi":"„Å≥", "bu":"„Å∂", "be":"„Åπ", "bo":"„Åº", "pa":"„Å±", "pi":"„Å¥", "pu":"„Å∑", "pe":"„Å∫", "po":"„ÅΩ", "kya":"„Åç„ÇÉ", "kyu":"„Åç„ÇÖ", "kyo":"„Åç„Çá", "sha":"„Åó„ÇÉ", "shu":"„Åó„ÇÖ", "sho":"„Åó„Çá", "cha":"„Å°„ÇÉ", "chu":"„Å°„ÇÖ", "cho":"„Å°„Çá", "nya":"„Å´„ÇÉ", "nyu":"„Å´„ÇÖ", "nyo":"„Å´„Çá", "hya":"„Å≤„ÇÉ", "hyu":"„Å≤„ÇÖ", "hyo":"„Å≤„Çá", "mya":"„Åø„ÇÉ", "myu":"„Åø„ÇÖ", "myo":"„Åø„Çá", "rya":"„Çä„ÇÉ", "ryu":"„Çä„ÇÖ", "ryo":"„Çä„Çá", "gya":"„Åé„ÇÉ", "gyu":"„Åé„ÇÖ", "gyo":"„Åé„Çá", "ja":"„Åò„ÇÉ", "ju":"„Åò„ÇÖ", "jo":"„Åò„Çá", "bya":"„Å≥„ÇÉ", "byu":"„Å≥„ÇÖ", "byo":"„Å≥„Çá", "pya":"„Å¥„ÇÉ", "pyu":"„Å¥„ÇÖ", "pyo":"„Å¥„Çá"
            };
            
            function toHiragana(romaji) {
                let hiragana = '';
                let i = 0;
                // Refined romaji cleaning
                romaji = romaji.toLowerCase()
                               .replace(/n'/, 'n')
                               .replace(/tchi/g, 'cchi'); // Handle edge case like 'matcha'
                while (i < romaji.length) {
                    // Handle double consonants (sokuon)
                    if (i + 1 < romaji.length && romaji[i] !== 'n' && romaji[i] === romaji[i+1]) {
                        hiragana += '„Å£';
                        i++;
                        continue;
                    }
                    let found = false;
                    // Check for 3-character kana
                    if (i + 2 < romaji.length) {
                        const threeChar = romaji.substring(i, i + 3);
                        if (wanakana[threeChar]) {
                            hiragana += wanakana[threeChar];
                            i += 3;
                            found = true;
                        }
                    }
                    // Check for 2-character kana
                    if (!found && i + 1 < romaji.length) {
                        const twoChar = romaji.substring(i, i + 2);
                        if (wanakana[twoChar]) {
                            hiragana += wanakana[twoChar];
                            i += 2;
                            found = true;
                        }
                    }
                    // Handle 1-character kana
                    if (!found) {
                        const oneChar = romaji[i];
                        hiragana += wanakana[oneChar] || oneChar;
                        i += 1;
                    }
                }
                return hiragana;
            }

            const dom = {
                kanaDisplay: document.getElementById('kana-display'),
                kanjiDisplay: document.getElementById('kanji-display'),
                formDisplay: document.getElementById('form-display'),
                verbTypeDisplay: document.getElementById('verb-type-display'),
                answerInput: document.getElementById('answer-input'),
                checkButton: document.getElementById('check-button'),
                nextButton: document.getElementById('next-button'),
                feedbackMessage: document.getElementById('feedback-message'),
                correctAnswerDisplay: document.getElementById('correct-answer-display'),
                correctCount: document.getElementById('correct-count'),
                incorrectCount: document.getElementById('incorrect-count'),
                resetButton: document.getElementById('reset-button'),
                topicSelect: document.getElementById('topic-select'),
                introPanel: document.getElementById('introduction-panel'),
                introTitle: document.getElementById('intro-title'),
                introSectionsContainer: document.getElementById('intro-sections-container'),
                startPracticeButton: document.getElementById('start-practice-button'),
                prevIntroSlideButton: document.getElementById('prev-intro-slide-button'),
                nextIntroSlideButton: document.getElementById('next-intro-slide-button'),
                cardPanel: document.querySelector('.card-panel'),
                feedbackArea: document.querySelector('.feedback-area'),
                progressArea: document.querySelector('.progress-area')
            };

            let state = {
                learningQueue: [],
                currentCard: null,
                correctCount: 0,
                incorrectCount: 0,
                currentTopic: "masu",
                currentMode: "introduction",
                currentIntroSlideIndex: 0
            };

            const saveState = () => {
                const stateToSave = { ...state };
                // Don't save the queue if not in practice mode to avoid stale queues
                if (state.currentMode !== 'practice') {
                    stateToSave.learningQueue = [];
                }
                localStorage.setItem('conjugationPracticeState', JSON.stringify(stateToSave));
            };
            const updateCounts = () => {
                dom.correctCount.textContent = state.correctCount;
                dom.incorrectCount.textContent = state.incorrectCount;
            };

            const loadState = () => {
                const savedState = localStorage.getItem('conjugationPracticeState');
                if (savedState) {
                    const loaded = JSON.parse(savedState);
                    state.currentTopic = loaded.currentTopic || "masu";
                    state.correctCount = loaded.correctCount || 0;
                    state.incorrectCount = loaded.incorrectCount || 0;
                    state.learningQueue = loaded.learningQueue || []; // Load the practice queue
                    state.currentMode = loaded.currentMode || "introduction";
                    state.currentIntroSlideIndex = loaded.currentIntroSlideIndex || 0;
                }
                dom.topicSelect.value = state.currentTopic;
                updateCounts();
            };

            const displayIntroductionUI = () => {
                [dom.cardPanel, dom.answerInput, dom.checkButton, dom.nextButton, dom.feedbackArea, dom.progressArea]
                    .forEach(el => el.classList.add('hidden'));

                dom.introPanel.classList.remove('hidden');
                dom.introSectionsContainer.innerHTML = '';

                const topicKey = state.currentTopic;
                const isGrammarTopic = topicKey.startsWith('grammar_');
                
                // Hide nav buttons for grammar, show for conjugations
                dom.prevIntroSlideButton.parentElement.style.display = isGrammarTopic ? 'none' : 'flex';
                // Always hide start practice button initially for grammar topics
                dom.startPracticeButton.classList.toggle('hidden', isGrammarTopic);

                if (isGrammarTopic) {
                    const grammarIndex = parseInt(topicKey.split('_')[1], 10);
                    const grammarPoint = japaneseGrammar[grammarIndex];
                    
                    if (grammarPoint) {
                        dom.introTitle.textContent = grammarPoint.grammar;
                        let html = `<h3>${grammarPoint.meaning} (JLPT ${grammarPoint.level})</h3>`;
                        html += `<p>${grammarPoint.explanation}</p>`;
                        
                        grammarPoint.examples.forEach(ex => {
                            html += `
                                <div class="grammar-example">
                                    <p class="jp">${ex.jp}</p>
                                    <p class="kana">${ex.kana}</p>
                                    <p class="en">${ex.en}</p>
                                </div>
                            `;
                        });
                        dom.introSectionsContainer.innerHTML = html;
                    }
                } else {
                    const introContent = formIntroContent[topicKey];
                    if (introContent && introContent.sections) {
                        dom.introTitle.textContent = introContent.title;
                        const totalSlides = introContent.sections.length;
                        const section = introContent.sections[state.currentIntroSlideIndex];
                        if (section) {
                            let html = `<h3>${section.heading}</h3>`;
                             html += section.content.split('\n').map(line => {
                                 line = line.trim();
                                 if (line.startsWith('‚Ä¢')) {
                                     return `<ul><li>${line.substring(1).trim().replace(/\* Example: (.*?) -> (.*?)/g, '<b>$1</b> &rarr; <b>$2</b>')}</li></ul>`;
                                 }
                                 return `<p>${line}</p>`;
                             }).join('');
                             dom.introSectionsContainer.innerHTML = html.replace(/<ul>\s*<\/ul>/g, '');
                        }
                        dom.prevIntroSlideButton.disabled = state.currentIntroSlideIndex === 0;
                        dom.nextIntroSlideButton.style.display = (state.currentIntroSlideIndex === totalSlides - 1) ? 'none' : 'block';
                        dom.startPracticeButton.classList.toggle('hidden', state.currentIntroSlideIndex !== totalSlides - 1);
                    } else {
                        // If no intro content, go straight to practice
                        startPractice();
                    }
                }
            };
            
            const displayPracticeUI = () => {
                [dom.introPanel, dom.startPracticeButton].forEach(el => el.classList.add('hidden'));
                [dom.cardPanel, dom.answerInput, dom.checkButton, dom.feedbackArea, dom.progressArea]
                    .forEach(el => el.classList.remove('hidden'));

                dom.answerInput.value = '';
                dom.answerInput.className = '';
                dom.feedbackMessage.textContent = '';
                dom.correctAnswerDisplay.textContent = '';
                dom.checkButton.classList.remove('hidden');
                dom.nextButton.classList.add('hidden');
                dom.answerInput.focus();
            };

            const startPractice = () => {
                state.currentMode = 'practice';
                generateNewPracticeSession();
                displayNextCard();
            };

            const generateNewPracticeSession = () => {
                const formKey = state.currentTopic;
                let wordPool = [];

                const formInfo = conjugationForms.find(f => f.key === formKey);
                if (!formInfo) return;

                if (formInfo.display.includes('Adjective')) {
                    const adjType = formInfo.display.includes('I-Adjective') ? 'i-adjective' : 'na-adjective';
                    wordPool = japaneseAdjectives.filter(adj => adj.type.startsWith(adjType) && adj.conjugations[formKey]);
                } else {
                    wordPool = japaneseVerbs.filter(verb => verb.conjugations[formKey]);
                }
                
                state.learningQueue = wordPool.map(item => ({ item, formKey }))
                                              .sort(() => Math.random() - 0.5);
            };

            const displayNextCard = () => {
                displayPracticeUI();
                if (state.learningQueue.length === 0) {
                    dom.kanaDisplay.textContent = "üéâ";
                    dom.kanjiDisplay.textContent = "Round Complete!";
                    dom.formDisplay.textContent = "Select a new topic or reset.";
                    dom.verbTypeDisplay.textContent = "";
                    [dom.answerInput, dom.nextButton, dom.checkButton].forEach(el => el.classList.add('hidden'));
                    return;
                }

                state.currentCard = state.learningQueue.shift();
                const { item, formKey } = state.currentCard;
                const formInfo = conjugationForms.find(f => f.key === formKey);

                dom.kanaDisplay.textContent = item.kana;
                dom.kanjiDisplay.textContent = item.word === item.kana ? '' : item.word;
                dom.formDisplay.textContent = formInfo ? formInfo.display : '';
                dom.verbTypeDisplay.textContent = item.type;
            };

            const checkAnswer = () => {
                if (!state.currentCard) return;

                const userAnswerRomaji = dom.answerInput.value.trim();
                const userAnswerHiragana = toHiragana(userAnswerRomaji);
                const { item, formKey } = state.currentCard;
                const correctAnswerHiragana = item.conjugations[formKey];

                if (userAnswerHiragana === correctAnswerHiragana) {
                    dom.feedbackMessage.textContent = "Correct! üëç";
                    dom.feedbackMessage.className = 'correct';
                    dom.answerInput.classList.add('correct');
                    state.correctCount++;
                } else {
                    dom.feedbackMessage.textContent = "Incorrect üëé";
                    dom.feedbackMessage.className = 'incorrect';
                    dom.answerInput.classList.add('incorrect');
                    dom.correctAnswerDisplay.textContent = `Correct: ${correctAnswerHiragana}`;
                    state.incorrectCount++;
                    // Put the incorrect card back in the queue to practice again soon
                    state.learningQueue.splice(Math.min(3, state.learningQueue.length), 0, state.currentCard);
                }

                updateCounts();
                saveState();
                dom.checkButton.classList.add('hidden');
                dom.nextButton.classList.remove('hidden');
                dom.nextButton.focus();
            };
            
            const populateTopicSelect = () => {
                const createOption = (value, text) => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = text;
                    return option;
                };
                const createOptgroup = (label) => {
                    const group = document.createElement('optgroup');
                    group.label = label;
                    return group;
                };

                const conjugationsGroup = createOptgroup('Conjugations');
                conjugationForms.forEach(form => {
                    if (form.category !== 'Particles') {
                         conjugationsGroup.appendChild(createOption(form.key, form.display));
                    }
                });
                dom.topicSelect.appendChild(conjugationsGroup);

                const grammarN5Group = createOptgroup('Grammar (N5)');
                const grammarN4Group = createOptgroup('Grammar (N4)');
                
                japaneseGrammar.forEach((point, index) => {
                    const option = createOption(`grammar_${index}`, point.grammar);
                    if (point.level === "N5") {
                        grammarN5Group.appendChild(option);
                    } else if (point.level === "N4") {
                        grammarN4Group.appendChild(option);
                    }
                });
                dom.topicSelect.appendChild(grammarN5Group);
                dom.topicSelect.appendChild(grammarN4Group);
            };

            // --- Event Listeners ---
            dom.answerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (!dom.checkButton.classList.contains('hidden')) {
                        checkAnswer();
                    } else if (!dom.nextButton.classList.contains('hidden')) {
                        displayNextCard();
                    }
                }
            });

            dom.checkButton.addEventListener('click', checkAnswer);
            dom.nextButton.addEventListener('click', displayNextCard);
            dom.startPracticeButton.addEventListener('click', startPractice);

            dom.topicSelect.addEventListener('change', (e) => {
                state.currentTopic = e.target.value;
                state.currentMode = 'introduction';
                state.currentIntroSlideIndex = 0;
                displayIntroductionUI();
                saveState();
            });
            
            dom.prevIntroSlideButton.addEventListener('click', () => {
                if (state.currentIntroSlideIndex > 0) {
                    state.currentIntroSlideIndex--;
                    displayIntroductionUI();
                }
            });

            dom.nextIntroSlideButton.addEventListener('click', () => {
                const introContent = formIntroContent[state.currentTopic];
                if (introContent && state.currentIntroSlideIndex < introContent.sections.length - 1) {
                    state.currentIntroSlideIndex++;
                    displayIntroductionUI();
                }
            });

            dom.resetButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset your session scores?')) {
                    state.correctCount = 0;
                    state.incorrectCount = 0;
                    updateCounts();
                    saveState();
                }
            });

            // --- Initial Load ---
            populateTopicSelect();
            loadState();
            
            // On page load, decide whether to continue a practice session or show the introduction
            if (state.currentMode === 'practice' && state.learningQueue.length > 0) {
                // If a practice session was saved, jump right back into it
                displayNextCard();
            } else {
                // Otherwise, show the introduction for the current topic
                state.currentMode = 'introduction';
                displayIntroductionUI();
            }
        });
    </script>
</body>
</html>
