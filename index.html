<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Verb and Adjective Conjugation Practice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f0f4f8;
            --card-color: #ffffff;
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --correct-color: #16a34a;
            --incorrect-color: #dc2626;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border-color: #cbd5e1;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 90vh; 
            margin: 0;
            padding: 1rem; /* Increased overall padding for better spacing on wide screens */
            box-sizing: border-box;
        }
        #app-container {
            background-color: var(--card-color);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px; /* Increased max-width for wider layout */
            padding: 2.5rem; /* Increased padding for more internal space */
            text-align: center;
            max-height: 98vh; 
            overflow-y: auto;
        }
        h1 {
            color: var(--text-dark);
            font-size: 2rem; /* Increased font size */
            margin-bottom: 1.5rem; /* Adjusted margin */
        }
        .level-selector {
            margin-bottom: 1.5rem; /* Adjusted margin */
        }
        .level-selector label {
            color: var(--text-light);
            margin-right: 0.75rem; /* Increased margin */
        }
        .level-selector select {
            padding: 0.6rem 1.2rem; /* Increased padding */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1.1rem; /* Increased font size */
        }
        /* Consistent styling for introduction and practice panels */
        .card-panel, #introduction-panel {
            background: linear-gradient(135deg, var(--primary-color), #60a5fa); /* Same gradient */
            color: white; /* Same text color */
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            min-height: 180px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); /* Lighter shadow for consistency */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #kana-display {
            font-size: 4rem; /* Increased font size */
            font-weight: 700;
        }
        #kanji-display {
            font-size: 1.2rem; /* Increased font size */
            opacity: 0.8;
        }
        #form-display {
            margin-top: 0.75rem; /* Adjusted margin */
            font-weight: 500;
            font-size: 1.2rem; /* Increased font size */
        }
        #verb-type-display {
            margin-top: 0.5rem; /* Adjusted margin */
            font-size: 1rem; /* Increased font size */
            opacity: 0.7;
            background-color: rgba(0,0,0,0.1);
            padding: 0.2rem 0.6rem; /* Adjusted padding */
            border-radius: 1rem;
        }
        #answer-input {
            width: 100%;
            padding: 1.2rem; /* Increased padding */
            font-size: 1.4rem; /* Increased font size */
            border: 2px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.2s, background-color 0.2s;
            margin-bottom: 1.5rem; /* Adjusted margin */
        }
        #answer-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        #answer-input.correct {
            border-color: var(--correct-color);
            background-color: #f0fdf4;
        }
        #answer-input.incorrect {
            border-color: var(--incorrect-color);
            background-color: #fef2f2;
        }
        button {
            width: 100%;
            padding: 1.1rem; /* Increased padding */
            font-size: 1.2rem; /* Increased font size */
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        #check-button { background-color: var(--correct-color); }
        #check-button:hover { background-color: #15803d; }
        #next-button { background-color: var(--primary-color); }
        #next-button:hover { background-color: var(--primary-hover); }

        #start-practice-button { background-color: var(--primary-color); }
        #start-practice-button:hover { background-color: var(--primary-hover); }

        .feedback-area {
            min-height: 4rem; /* Adjusted min-height */
            margin-top: 1.5rem; /* Adjusted margin */
        }
        #feedback-message { 
            font-size: 1.3rem; /* Increased font size */
            font-weight: bold; 
            transition: opacity 0.3s;
        }
        #feedback-message.correct { color: var(--correct-color); }
        #feedback-message.incorrect { color: var(--incorrect-color); }
        #correct-answer-display { 
            color: var(--text-light); 
            font-size: 1rem; /* Increased font size */
        }
        .progress-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem; /* Increased margin */
            padding-top: 1.2rem; /* Increased padding */
            border-top: 1px solid #e2e8f0;
        }
        .progress-area p { 
            color: var(--text-light); 
            font-size: 1rem; /* Increased font size */
            margin: 0.2rem 0; 
        }
        .progress-area span { font-weight: bold; color: var(--text-dark); }
        #reset-button {
            background: none;
            border: none;
            color: var(--incorrect-color);
            cursor: pointer;
            font-weight: bold;
            padding: 0.5rem;
            font-size: 1rem; /* Increased font size */
        }
        .hidden {
            display: none;
        }

        /* Introduction Panel Specific Styling (adjustments for consistency) */
        #introduction-panel {
            /* Inherits most styling from .card-panel */
            text-align: left; /* Keep text aligned left for paragraphs */
        }
        #introduction-panel h2 {
            font-size: 1.8rem; /* Adjusted for consistency */
            margin-bottom: 1rem;
            color: white; /* Changed to white for consistency with card panel */
            text-align: center; /* Center the title within the intro panel */
        }
        #introduction-panel h3 { /* New for section headings */
            font-size: 1.3rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: white; /* Consistent with other headings */
            text-align: left;
        }
        #introduction-panel p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 0.5rem; /* Reduced for closer paragraph spacing */
            color: white; /* Consistent with other text */
        }
        #introduction-panel ul {
            margin-left: 1.5rem;
            list-style: disc;
            color: white;
            padding: 0;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
        #introduction-panel li {
            margin-bottom: 0.4rem;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        #introduction-panel button {
            margin-top: 1.5rem; /* Adjusted spacing */
        }
    </style>
</head>
<body>

    <div id="app-container">
        <h1>Conjugation Dojo</h1>

        <div class="level-selector">
            <label for="topic-select">Topic:</label>
            <select id="topic-select">
                <!-- Options will be dynamically populated by JavaScript -->
            </select>
        </div>

        <!-- Introduction Panel -->
        <div id="introduction-panel" class="hidden">
            <h2 id="intro-title"></h2>
            <div id="intro-sections-container">
                <!-- Sections will be dynamically inserted here by JS -->
            </div>
            <button id="start-practice-button">Start Practice</button>
        </div>

        <!-- Conjugation Practice Panel -->
        <div class="card-panel">
            <p id="kana-display"></p>
            <p id="kanji-display"></p>
            <p id="form-display"></p>
            <p id="verb-type-display"></p>
        </div>

        <input type="text" id="answer-input" placeholder="Type Romaji here..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

        <button id="check-button">Check</button>
        <button id="next-button" class="hidden">Next</button>

        <div class="feedback-area">
            <p id="feedback-message"></p>
            <p id="correct-answer-display"></p>
        </div>

        <div class="progress-area">
            <div>
                <p>Correct: <span id="correct-count">0</span></p>
                <p>Incorrect: <span id="incorrect-count">0</span></p>
            </div>
            <button id="reset-button">Reset Session</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const japaneseVerbs = [
                { word: "行く", kana: "いく", meaning: "to go", type: "u-verb (special)", conjugations: { masu: "いきます", te: "いって", ta: "いった", nai: "いかない", masuNegative: "いきません", taNegative: "いかなかった", potential: "いける", volitional: "いこう", passive: "いかれる", causative: "いかせる", ba: "いけば", tara: "いったら", imperative: "いけ", desire: "いきたい", tsumori: "いく" }},
                { word: "食べる", kana: "たべる", meaning: "to eat", type: "ru-verb", conjugations: { masu: "たべます", te: "たべて", ta: "たべた", nai: "たべない", masuNegative: "たべません", taNegative: "たべなかった", potential: "たべられる", volitional: "たべよう", passive: "たべられる", causative: "たべさせる", ba: "たべれば", tara: "たべたら", imperative: "たべろ", desire: "たべたい", tsumori: "たべる" }},
                { word: "飲む", kana: "のむ", meaning: "to drink", type: "u-verb", conjugations: { masu: "のみます", te: "のんで", ta: "のんだ", nai: "のまない", masuNegative: "のみません", taNegative: "のまなかった", potential: "のめる", volitional: "のもう", passive: "のまれる", causative: "のませる", ba: "のめば", tara: "のんだら", imperative: "のめ", desire: "のみたい", tsumori: "のむ" }},
                { word: "する", kana: "する", meaning: "to do", type: "irregular", conjugations: { masu: "します", te: "して", ta: "した", nai: "しない", masuNegative: "しません", taNegative: "しなかった", potential: "できる", volitional: "しよう", passive: "される", causative: "させる", ba: "すれば", tara: "したら", imperative: "しろ", desire: "したい", tsumori: "する" }},
                { word: "来る", kana: "くる", meaning: "to come", type: "irregular", conjugations: { masu: "きます", te: "きて", ta: "きた", nai: "こない", masuNegative: "きません", taNegative: "こなかった", potential: "こられる", volitional: "こよう", passive: "こられる", causative: "こさせる", ba: "くれば", tara: "きたら", imperative: "こい", desire: "きたい", tsumori: "くる" }},
                { word: "書く", kana: "かく", meaning: "to write", type: "u-verb", conjugations: { masu: "かきます", te: "かいて", ta: "かいた", nai: "かかない", masuNegative: "かきません", taNegative: "かかなかった", potential: "かける", volitional: "かこう", passive: "かかれる", causative: "かかせる", ba: "かけば", tara: "かいたら", imperative: "かけ", desire: "かきたい", tsumori: "かく" }},
                { word: "読む", kana: "よむ", meaning: "to read", type: "u-verb", conjugations: { masu: "よみます", te: "よんで", ta: "よんだ", nai: "よまない", masuNegative: "よみません", taNegative: "よまなかった", potential: "よめる", volitional: "よもう", passive: "よまれる", causative: "よませる", ba: "よめば", tara: "よんだら", imperative: "よめ", desire: "よみたい", tsumori: "よむ" }},
                { word: "話す", kana: "はなす", meaning: "to speak", type: "u-verb", conjugations: { masu: "はなします", te: "はなして", ta: "はなした", nai: "はなさない", masuNegative: "はなしません", taNegative: "はなさなかった", potential: "はなせる", volitional: "はなそう", passive: "はなされる", causative: "はなさせる", ba: "はなせば", tara: "はなしたら", imperative: "はなせ", desire: "はなしたい", tsumori: "はなす" }},
                { word: "見る", kana: "みる", meaning: "to see", type: "ru-verb", conjugations: { masu: "みます", te: "みて", ta: "みた", nai: "みない", masuNegative: "みません", taNegative: "みなかった", potential: "みられる", volitional: "みよう", passive: "みられる", causative: "みさせる", ba: "みれば", tara: "みたら", imperative: "みろ", desire: "みたい", tsumori: "みる" }},
                { word: "買う", kana: "かう", meaning: "to buy", type: "u-verb", conjugations: { masu: "かいます", te: "かって", ta: "かった", nai: "かわない", masuNegative: "かいません", taNegative: "かわなかった", potential: "かえる", volitional: "かおう", passive: "かわれる", causative: "かわせる", ba: "かえば", tara: "かったら", imperative: "かえ", desire: "かきたい", tsumori: "かう" }},
                { word: "待つ", kana: "まつ", meaning: "to wait", type: "u-verb", conjugations: { masu: "まちます", te: "まって", ta: "まった", nai: "またない", masuNegative: "まちません", taNegative: "またなかった", potential: "まてる", volitional: "まとう", passive: "またれる", causative: "またせる", ba: "まてば", tara: "まったら", imperative: "まて", desire: "まちたい", tsumori: "まつ" }},
                { word: "帰る", kana: "かえる", meaning: "to return", type: "u-verb", conjugations: { masu: "かえります", te: "かえって", ta: "かえった", nai: "かえらない", masuNegative: "かえりません", taNegative: "かえなかった", potential: "かえれる", volitional: "かえろう", passive: "かえられる", causative: "かえらせる", ba: "かえれば", tara: "かえったら", imperative: "かえ", desire: "かえりたい", tsumori: "かえる" }}
            ];

            const japaneseAdjectives = [
                { word: "高い", kana: "たかい", type: "i-adjective", meaning: "expensive, tall, high", conjugations: { iAdjectiveNegative: "たかくない", iAdjectivePast: "たかかった", iAdjectivePastNegative: "たかくなかった" }},
                { word: "安い", kana: "やすい", type: "i-adjective", meaning: "cheap", conjugations: { iAdjectiveNegative: "やすくない", iAdjectivePast: "やすかった", iAdjectivePastNegative: "やすくなかった" }},
                { word: "好き", kana: "すき", type: "na-adjective", meaning: "likable, favorite", conjugations: { naAdjectiveNegative: "すきじゃない", naAdjectivePast: "すきだった", naAdjectivePastNegative: "すきじゃなかった" }},
                { word: "静か", kana: "しずか", type: "na-adjective", meaning: "quiet", conjugations: { naAdjectiveNegative: "しずかじゃない", naAdjectivePast: "しずかだった", naAdjectivePastNegative: "しずかじゃなかった" }},
                { word: "楽しい", kana: "たのしい", type: "i-adjective", meaning: "fun", conjugations: { iAdjectiveNegative: "たのしくない", iAdjectivePast: "たのしかった", iAdjectivePastNegative: "たのしくなかった" }},
                { word: "元気", kana: "げんき", type: "na-adjective", meaning: "healthy, energetic", conjugations: { naAdjectiveNegative: "げんきじゃない", naAdjectivePast: "げんきだった", naAdjectivePastNegative: "げんきじゃなかった" }}
            ];

            const conjugationForms = [
                { key: "masu", display: "Masu Form (ます)" },
                { key: "masuNegative", display: "Masu Negative (ません)" },
                { key: "te", display: "Te Form (て)" },
                { key: "ta", display: "Past Tense (た)" },
                { key: "nai", display: "Nai Form (ない)" },
                { key: "taNegative", display: "Past Negative (なかった)" },
                { key: "potential", display: "Potential Form (できる)" },
                { key: "volitional", display: "Volitional Form (しよう)" },
                { key: "desire", display: "Desire Form (たい)" },
                { key: "tsumori", display: "Tsumori Form (つもり)" },
                { key: "passive", display: "Passive Form" },
                { key: "causative", display: "Causative Form" },
                { key: "ba", display: "Conditional (ば)" },
                { key: "tara", display: "Conditional (たら)" },
                { key: "imperative", display: "Imperative Form" },
                { key: "iAdjectiveNegative", display: "I-Adjective Negative (くない)" },
                { key: "iAdjectivePast", display: "I-Adjective Past (かった)" },
                { key: "iAdjectivePastNegative", display: "I-Adjective Past Negative (くなかった)" },
                { key: "naAdjectiveNegative", display: "Na-Adjective Negative (じゃない)" },
                { key: "naAdjectivePast", display: "Na-Adjective Past (だった)" },
                { key: "naAdjectivePastNegative", display: "Na-Adjective Past Negative (じゃなかった)" }
            ];

            // New: Detailed introduction content for each individual conjugation form
            const formIntroContent = {
                "masu": {
                    title: "Masu Form (ます)",
                    sections: [
                        { heading: "What is it?", content: "The polite present/future tense in Japanese. Used for general statements, polite requests, and habitual actions." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「ます」 (masu).\n    * Example: 食べる (taberu) -> 食べます (tabemasu) - "to eat / eat / will eat"\n    * Example: 見る (miru) -> 見ます (mimasu) - "to see / see / will see"`
                        },
                        { heading: "", content: 
                            `•  **U-verbs (Group 1)**: Change the final U-vowel sound to the I-vowel sound, then add 「ます」 (masu).\n    * Example: 読む (yomu) -> 読みます (yomimasu) - "to read / read / will read"\n    * Example: 飲む (nomu) -> 飲みます (nomimasu) - "to drink / drink / will drink"`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: These have unique conjugations.\n    * する (suru) -> します (shimasu) - "to do / do / will do"\n    * 来る (kuru) -> きます (kimasu) - "to come / come / will come"`
                        }
                    ]
                },
                "masuNegative": {
                    title: "Masu Negative (ません)",
                    sections: [
                        { heading: "What is it?", content: "The polite negative present/future tense. Expresses 'do not' or 'will not' in a polite context." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「ません」 (masen).\n    * Example: 食べる (taberu) -> 食べません (tabemasen) - "do not eat / will not eat"\n    * Example: 見る (miru) -> 見ません (mimasen) - "do not see / will not see"`
                        },
                        { heading: "", content: 
                            `•  **U-verbs (Group 1)**: Change the final U-vowel sound to the I-vowel sound, then add 「ません」 (masen).\n    * Example: 読む (yomu) -> 読みません (yomimasen) - "do not read / will not read"\n    * Example: 飲む (nomu) -> 飲みません (nomimasen) - "do not drink / will not drink"`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> しません (shimasen) - "do not do / will not do"\n    * 来る (kuru) -> きません (kimasen) - "do not come / will not come"`
                        }
                    ]
                },
                "te": {
                    title: "Te Form (て)",
                    sections: [
                        { heading: "What is it?", content: "A versatile form used to connect clauses, give requests, express continuous actions, and combine with other grammar patterns." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「て」 (te).\n    * Example: 食べる (taberu) -> 食べて (tabete)\n    * Example: 見る (miru) -> 見て (mite)`
                        },
                        { heading: "", content: 
                            `•  **U-verbs (Group 1)**: Follow specific sound change rules (音便 - onbin):\n    * Verbs ending in: \n        * う, つ, る -> って (utte, tte, tte) (e.g., 買う -> 買って, 待つ -> 待って, 帰る -> 帰って)\n        * む, ぶ, ぬ -> んで (nde, nde, nde) (e.g., 飲む -> 飲んで)\n        * く -> いて (ite) (e.g., 書く -> 書いて)\n        * ぐ -> いで (ide) (e.g., 泳ぐ -> 泳いで)\n        * す -> して (shite) (e.g., 話す -> 話して)`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> して (shite)\n    * 来る (kuru) -> きて (kite)`
                        }
                    ]
                },
                "ta": {
                    title: "Past Tense (た)",
                    sections: [
                        { heading: "What is it?", content: "The plain past tense form. Used in informal conversation and as a base for many other grammar patterns." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: The conjugation rules for the plain past tense (た form) are almost identical to the Te form, but 「て」 (te) is replaced with 「た」 (ta), and 「で」 (de) is replaced with 「だ」 (da).\n\n•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「た」 (ta).\n    * Example: 食べる (taberu) -> 食べた (tabeta) - "ate"\n\n•  **U-verbs (Group 1)**: Follow sound change rules (音便 - onbin):\n    * Verbs ending in: \n        * う, つ, る -> った (utta, tta, tta) (e.g., 買う -> 買った, 待つ -> 待った, 帰る -> 帰った)\n        * む, ぶ, ぬ -> んだ (nda, nda, nda) (e.g., 飲む -> 飲んだ)\n        * く -> いた (ita) (e.g., 書く -> 書いた)\n        * ぐ -> いだ (ida) (e.g., 泳ぐ -> 泳いだ)\n        * す -> した (shita) (e.g., 話す -> 話した)`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> した (shita)\n    * 来る (kuru) -> きた (kita)`
                        }
                    ]
                },
                "nai": {
                    title: "Nai Form (ない)",
                    sections: [
                        { heading: "What is it?", content: "The plain negative form of verbs. It expresses 'do not' or 'will not' in an informal context." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「ない」 (nai).\n    * Example: 食べる (taberu) -> 食べない (tabenai) - "do not eat / will not eat"\n    * Example: 見る (miru) -> 見ない (minai) - "do not see / will not see"`
                        },
                        { heading: "", content: 
                            `•  **U-verbs (Group 1)**: Change the final U-vowel sound to the A-vowel sound, then add 「ない」 (nai).\n    * Example: 飲む (nomu) -> 飲まない (nomanai) - "do not drink / will not drink"\n    * Exception for U-verbs ending in 「う」 (u): Change 「う」 to 「わ」 (wa), then add 「ない」 (nai). (e.g., 買う -> 買わない)`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> しない (shinai) - "do not do / will not do"\n    * 来る (kuru) -> こない (konai) - "do not come / will not come"`
                        }
                    ]
                },
                "taNegative": {
                    title: "Past Negative (なかった)",
                    sections: [
                        { heading: "What is it?", content: "The plain past negative tense. Expresses 'did not' in an informal context." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: This form is derived from the **Nai form**. Simply remove the final 「い」 (i) from the Nai form and add 「かった」 (katta).\n    * Example: 食べない (tabenai) -> 食べなかった (tabenakatta) - "did not eat"\n    * Example: 飲まない (nomanai) -> 飲まなかった (nomanakatta) - "did not drink"\n    * Example: しない (shinai) -> しなかった (shinakatta) - "did not do"`
                        }
                    ]
                },
                "potential": {
                    title: "Potential Form (できる)",
                    sections: [
                        { heading: "What is it?", content: "Expresses ability, meaning 'can do' or 'is able to do something'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「られる」 (rareru).\n    * Example: 食べる (taberu) -> 食べられる (taberareru) - "can eat"\n    * Example: 見る (miru) -> 見られる (mirareru) - "can see"`
                        },
                        { heading: "", content: 
                            `•  **U-verbs (Group 1)**: Change the final U-vowel sound to the E-vowel sound, then add 「る」 (ru).\n    * Example: 読む (yomu) -> 読める (yomeru) - "can read"\n    * Example: 飲む (nomu) -> 飲める (nomeru) - "can drink"`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> できる (dekiru) - "can do"\n    * 来る (kuru) -> こられる (korareru) - "can come"`
                        }
                    ]
                },
                "volitional": {
                    title: "Volitional Form (しよう)",
                    sections: [
                        { heading: "What is it?", content: "Expresses intention or invitation. Roughly translates to 'let's do' or 'I intend to do'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「よう」 (you).\n    * Example: 食べる (taberu) -> 食べよう (tabeyou) - "let's eat"\n    * Example: 見る (miru) -> 見よう (miyou) - "let's see"`
                        },
                        { heading: "", content: 
                            `•  **U-verbs (Group 1)**: Change the final U-vowel sound to the O-vowel sound, then add 「う」 (u).\n    * Example: 読む (yomu) -> 読もう (yomou) - "let's read"\n    * Example: 飲む (nomu) -> 飲もう (nomou) - "let's drink"`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> しよう (shiyou) - "let's do"\n    * 来る (kuru) -> こよう (koyou) - "let's come"`
                        }
                    ]
                },
                "desire": {
                    title: "Desire Form (たい)",
                    sections: [
                        { heading: "What is it?", content: "Expresses a desire or wish to do something, meaning 'want to do'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Take the **Masu Stem** (Masu form without ます), then add 「たい」 (tai).\n    * Example: 食べます (tabemasu) -> 食べたい (tabetai) - "want to eat"\n    * Example: 飲みます (nomimasu) -> 飲みたい (nomitai) - "want to drink"\n    * Example: します (shimasu) -> したい (shitai) - "want to do"`
                        },
                        { heading: "Treat like an I-Adjective:", content: "Once conjugated to the たい form, it behaves like an I-adjective for further conjugations (e.g., 行きたくない - *ikitakunai* 'don't want to go')." }
                    ]
                },
                "tsumori": {
                    title: "Tsumori Form (つもり)",
                    sections: [
                        { heading: "What is it?", content: "Used to express a plan or intention, meaning 'planning to do' or 'intend to do'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Attach 「つもり」 (tsumori) directly to the **Plain Form (dictionary form)** of the verb.\n    * Example: 食べる (taberu) -> 食べるつもり (taberu tsumori) - "planning to eat"\n    * Example: 行く (iku) -> 行くつもり (iku tsumori) - "planning to go"\n    * Example: しない (shinai) -> しないつもり (shinai tsumori) - "planning not to do"`
                        }
                    ]
                },
                "passive": {
                    title: "Passive Form",
                    sections: [
                        { heading: "What is it?", content: "Indicates that the subject is receiving an action, meaning 'to be [verbed]' or 'to get [verbed]'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「られる」 (rareru).\n    * Example: 食べる (taberu) -> 食べられる (taberareru) - "to be eaten"\n\n•  **U-verbs (Group 1)**: Change the final U-vowel sound to the A-vowel sound, then add 「れる」 (reru).\n    * Example: 飲む (nomu) -> 飲まれる (nomareru) - "to be drunk"\n    * Exception for U-verbs ending in 「う」 (u): Change 「う」 to 「わ」 (wa), then add 「れる」 (reru). (e.g., 買う -> 買われる)`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> される (sareru) - "to be done"\n    * 来る (kuru) -> こられる (korareru) - "to be come (visited)"`
                        }
                    ]
                },
                "causative": {
                    title: "Causative Form",
                    sections: [
                        { heading: "What is it?", content: "Expresses making or letting someone do something. Meaning 'make/let [someone] [do something]'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「させる」 (saseru).\n    * Example: 食べる (taberu) -> 食べさせる (tabesaseru) - "make/let eat"\n\n•  **U-verbs (Group 1)**: Change the final U-vowel sound to the A-vowel sound, then add 「せる」 (seru).\n    * Example: 読む (yomu) -> 読ませる (yomaseru) - "make/let read"\n    * Exception for U-verbs ending in 「う」 (u): Change 「う」 to 「わ」 (wa), then add 「せる」 (seru). (e.g., 買う -> 買わせる)`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> させる (saseru) - "make/let do"\n    * 来る (kuru) -> こさせる (kosaseru) - "make/let come"`
                        }
                    ]
                },
                "ba": {
                    title: "Conditional (ば)",
                    sections: [
                        { heading: "What is it?", content: "One type of conditional clause, meaning 'if... then'. Often expresses natural consequences, general conditions, or things that are habitually true." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「れば」 (reba).\n    * Example: 食べる (taberu) -> 食べれば (tabereba) - "if (one) eats"\n\n•  **U-verbs (Group 1)**: Change the final U-vowel sound to the E-vowel sound, then add 「ば」 (ba).\n    * Example: 飲む (nomu) -> 飲めば (nomeba) - "if (one) drinks"\n\n•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> すれば (sureba)\n    * 来る (kuru) -> くれば (kureba)`
                        }
                    ]
                },
                "tara": {
                    title: "Conditional (たら)",
                    sections: [
                        { heading: "What is it?", content: "A very common conditional clause, meaning 'if/when... then'. It implies that the action in the first clause must be completed before the second clause happens, or expresses a surprising/unexpected result." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Attach 「ら」 (ra) directly to the **Plain Past (た form)** of the verb.\n    * Example: 食べた (tabeta) -> 食べたら (tabetara) - "if/when (one) ate"\n    * Example: 飲んだ (nonda) -> 飲んだら (nondara) - "if/when (one) drank"\n    * Example: した (shita) -> したら (shitara) - "if/when (one) did"`
                        }
                    ]
                },
                "imperative": {
                    title: "Imperative Form",
                    sections: [
                        { heading: "What is it?", content: "Expresses direct commands. It can sound strong or impolite depending on context and speaker/listener relationship, so use with care." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Ru-verbs (Group 2)**: Remove the final 「る」 (ru), then add 「ろ」 (ro).\n    * Example: 食べる (taberu) -> 食べろ (tabero) - "Eat!"\n    * Example: 見る (miru) -> 見ろ (miro) - "Look!"`
                        },
                        { heading: "", content: 
                            `•  **U-verbs (Group 1)**: Change the final U-vowel sound to the E-vowel sound.\n    * Example: 飲む (nomu) -> 飲め (nome) - "Drink!"\n    * Example: 書く (kaku) -> 書け (kake) - "Write!"`
                        },
                        { heading: "", content: 
                            `•  **Irregular Verbs**: Memorize these!\n    * する (suru) -> しろ (shiro) - "Do!"\n    * 来る (kuru) -> こい (koi) - "Come!"`
                        }
                    ]
                },
                "iAdjectiveNegative": {
                    title: "I-Adjective Negative (くない)",
                    sections: [
                        { heading: "What is it?", content: "Used to express the negative state of an I-adjective. Meaning 'is not [adjective]'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Remove the final 「い」 (i) from the dictionary form, then add 「くない」 (kunai).\n    * Example: 高い (takai) -> 高くない (takakunai) - "is not expensive"\n    * Example: 安い (yasui) -> 安くない (yasukunai) - "is not cheap"`
                        },
                        { heading: "Irregular: いい (Good)", content: `The adjective **いい (ii)** meaning "good" is irregular for its negative form:\n\n•  いい (ii) -> よくない (yokunai) - "is not good"` }
                    ]
                },
                "iAdjectivePast": {
                    title: "I-Adjective Past (かった)",
                    sections: [
                        { heading: "What is it?", content: "Used to express the past tense of an I-adjective. Meaning 'was [adjective]'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Remove the final 「い」 (i) from the dictionary form, then add 「かった」 (katta).\n    * Example: 高い (takai) -> 高かった (takakatta) - "was expensive"\n    * Example: 楽しい (tanoshii) -> 楽しかった (tanoshikatta) - "was fun"`
                        },
                        { heading: "Irregular: いい (Good)", content: `The adjective **いい (ii)** meaning "good" is irregular for its past form:\n\n•  いい (ii) -> よかった (yokatta) - "was good"` }
                    ]
                },
                "iAdjectivePastNegative": {
                    title: "I-Adjective Past Negative (くなかった)",
                    sections: [
                        { heading: "What is it?", content: "Used to express the past negative tense of an I-adjective. Meaning 'was not [adjective]'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Remove the final 「い」 (i) from the dictionary form, then add 「くなかった」 (kunakatta).\n    * This is essentially the Nai form of the adjective (くない) conjugated to its past tense (かった).\n    * Example: 高い (takai) -> 高くなかった (takakunakata) - "was not expensive"\n    * Example: 安い (yasui) -> 安くなかった (yasukunakatta) - "was not cheap"`
                        },
                        { heading: "Irregular: いい (Good)", content: `The adjective **いい (ii)** meaning "good" is irregular for its past negative form:\n\n•  いい (ii) -> よくなかった (yokunakatta) - "was not good"` }
                    ]
                },
                "naAdjectiveNegative": {
                    title: "Na-Adjective Negative (じゃない)",
                    sections: [
                        { heading: "What is it?", content: "Used to express the negative state of a Na-adjective. Meaning 'is not [adjective]'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Add 「じゃない」 (janai) directly to the dictionary form of the Na-adjective.\n    * Example: 好き (suki) -> 好きじゃない (suki janai) - "is not likable"\n    * Example: 静か (shizuka) -> 静かじゃない (shizuka janai) - "is not quiet"`
                        }
                    ]
                },
                "naAdjectivePast": {
                    title: "Na-Adjective Past (だった)",
                    sections: [
                        { heading: "What is it?", content: "Used to express the past tense of a Na-adjective. Meaning 'was [adjective]'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Add 「だった」 (datta) directly to the dictionary form of the Na-adjective.\n    * Example: 好き (suki) -> 好きだった (suki datta) - "was likable"\n    * Example: 元気 (genki) -> 元気だった (genki datta) - "was healthy"`
                        }
                    ]
                },
                "naAdjectivePastNegative": {
                    title: "Na-Adjective Past Negative (じゃなかった)",
                    sections: [
                        { heading: "What is it?", content: "Used to express the past negative tense of a Na-adjective. Meaning 'was not [adjective]'." },
                        { heading: "How to Conjugate:", content: 
                            `•  **Rule**: Add 「じゃなかった」 (janakatta) directly to the dictionary form of the Na-adjective.\n    * Example: 好き (suki) -> 好きじゃなかった (suki janakatta) - "was not likable"\n    * Example: 静か (shizuka) -> 静かじゃなかった (shizuka janakatta) - "was not quiet"`
                        }
                    ]
                }
            };


            const romajiToHiraganaMap = {
                // Keep longer keys first for correct matching
                "kya": "きゃ", "kyu": "きゅ", "kyo": "きょ", 
                "sha": "しゃ", "shu": "しゅ", "sho": "しょ", 
                "cha": "ちゃ", "chu": "ちゅ", "cho": "ちょ", 
                "nya": "にゃ", "nyu": "にゅ", "nyo": "にょ", 
                "hya": "ひゃ", "hyu": "ひゅ", "hyo": "ひょ", 
                "mya": "みゃ", "myu": "みゅ", "myo": "みょ", 
                "rya": "りゃ", "ryu": "りゅ", "ryo": "りょ", 
                "gya": "ぎゃ", "gyu": "ぎゅ", "gyo": "ぎょ", 
                "ja": "じゃ", "ju": "じゅ", "jo": "じょ", 
                "bya": "びゃ", "byu": "びゅ", "byo": "びょ", 
                "pya": "ぴゃ", "pyu": "ぴゅ", "pyo": "ぴょ", 
                "shi": "し", "chi": "ち", "tsu": "つ", "ji": "じ", "fu": "ふ", "wo": "を", 
                "ka": "か", "ki": "き", "ku": "く", "ke": "け", "ko": "こ", 
                "sa": "さ", "su": "す", "se": "se", "so": "そ", 
                "ta": "た", "te": "て", "to": "と", 
                "na": "な", "ni": "に", "nu": "ぬ", "ne": "ね", "no": "の", 
                "ha": "は", "hi": "ひ", "he": "へ", "ho": "ほ", 
                "ma": "ま", "mi": "み", "mu": "む", "me": "め", "mo": "も", 
                "ya": "や", "yu": "ゆ", "yo": "よ", 
                "ra": "ら", "ri": "り", "ru": "る", "re": "れ", "ro": "ろ", 
                "wa": "わ", 
                "ga": "が", "gi": "ぎ", "gu": "ぐ", "ge": "げ", "go": "ご", 
                "za": "ざ", "ze": "ぜ", "zo": "ぞ", 
                "da": "だ", "de": "で", "do": "ど", 
                "ba": "ば", "bi": "び", "bu": "ぶ", "be": "べ", "bo": "ぼ", 
                "pa": "ぱ", "pi": "ぴ", "pu": "ぷ", "pe": "ぺ", "po": "ぽ", 
                "a": "あ", "i": "い", "u": "う", "e": "え", "o": "お"
            };
            // Sort keys by length in descending order to ensure greedy matching (e.g., "chi" before "ch")
            const sortedRomajiKeys = Object.keys(romajiToHiraganaMap).sort((a, b) => b.length - a.length);

            // --- DOM ELEMENTS ---
            const dom = {
                kanaDisplay: document.getElementById('kana-display'),
                kanjiDisplay: document.getElementById('kanji-display'),
                formDisplay: document.getElementById('form-display'),
                verbTypeDisplay: document.getElementById('verb-type-display'),
                answerInput: document.getElementById('answer-input'),
                checkButton: document.getElementById('check-button'),
                nextButton: document.getElementById('next-button'),
                feedbackMessage: document.getElementById('feedback-message'),
                correctAnswerDisplay: document.getElementById('correct-answer-display'),
                correctCount: document.getElementById('correct-count'),
                incorrectCount: document.getElementById('incorrect-count'),
                resetButton: document.getElementById('reset-button'),
                topicSelect: document.getElementById('topic-select'),
                // New Introduction elements
                introPanel: document.getElementById('introduction-panel'),
                introTitle: document.getElementById('intro-title'),
                introSectionsContainer: document.getElementById('intro-sections-container'), // New container for sections
                startPracticeButton: document.getElementById('start-practice-button'),
                // Areas to hide/show
                cardPanel: document.querySelector('.card-panel'),
                feedbackArea: document.querySelector('.feedback-area'),
                progressArea: document.querySelector('.progress-area')
            };

            // --- STATE ---
            let state = {
                learningQueue: [],
                currentCard: null,
                correctCount: 0,
                incorrectCount: 0,
                currentTopic: "masu", // Default to Masu Form
                typedRomajiBuffer: "", // Stores the raw Romaji characters typed by the user
                currentMode: "introduction" // 'introduction' or 'practice'
            };

            // --- FUNCTIONS ---
            const convertRomajiToHiragana = (fullRomajiString) => {
                let hiraganaResult = "";
                let buffer = fullRomajiString.toLowerCase();
                let i = 0;

                while (i < buffer.length) {
                    let charsConsumed = 0;

                    // 1. Prioritize "nn" conversion for 'ん'
                    if (buffer.substring(i, i + 2) === "nn") {
                        hiraganaResult += "ん";
                        charsConsumed = 2;
                    }
                    // 2. Handle small tsu (っ) for double consonants (e.g., "tta" -> "った")
                    else if (i + 1 < buffer.length && buffer[i] === buffer[i + 1] && !"aiueon".includes(buffer[i])) {
                        hiraganaResult += "っ";
                        charsConsumed = 1;
                    }
                    // 3. Attempt to match longest Romaji syllable from the map
                    else {
                        for (const key of sortedRomajiKeys) {
                            if (buffer.substring(i).startsWith(key)) {
                                hiraganaResult += romajiToHiraganaMap[key];
                                charsConsumed = key.length;
                                break; // Found longest match, move to next part of buffer
                            }
                        }
                    }

                    // 4. Handle a standalone 'n' that should become 'ん' if not already consumed by "nn" or a syllable
                    if (charsConsumed === 0 && buffer[i] === 'n') {
                        const nextChar = (i + 1 < buffer.length) ? buffer[i + 1] : '';

                        // Check if 'n' followed by `nextChar` could form any known Romaji syllable (e.g., 'na', 'nyu')
                        let couldFormMappedSyllable = false;
                        for (const key of sortedRomajiKeys) {
                            if (key.startsWith('n' + nextChar)) { // Example: check if "na", "nyu" exist in map
                                couldFormMappedSyllable = true;
                                break;
                            }
                        }

                        // Convert 'n' to 'ん' if:
                        // a) It's the last character in the buffer (e.g., "hon")
                        // b) It's followed by a consonant AND that consonant doesn't form a mapped syllable with 'n' (e.g., "kankei" -> かんけい)
                        if (nextChar === '' || (!"aiueoy".includes(nextChar) && !couldFormMappedSyllable)) {
                            hiraganaResult += "ん";
                            charsConsumed = 1;
                        } else {
                            // If 'n' is followed by a vowel/y or a consonant that *could* form a syllable,
                            // then leave 'n' as Romaji for now. It will be re-evaluated with more input.
                            // This is crucial to allow "na" to form "な" instead of "んあ".
                            hiraganaResult += buffer[i]; // Append literally for now (keep as Romaji)
                            charsConsumed = 1;
                        }
                    } 
                    // 5. Fallback for any other unmatched characters (e.g., partial "k", "t", or unknown Romaji)
                    else if (charsConsumed === 0) {
                        hiraganaResult += buffer[i];
                        charsConsumed = 1;
                    }

                    i += charsConsumed;
                }
                return hiraganaResult;
            };

            const updateCounts = () => {
                dom.correctCount.textContent = state.correctCount;
                dom.incorrectCount.textContent = state.incorrectCount;
            };

            const saveState = () => {
                localStorage.setItem('conjugationPracticeState', JSON.stringify(state));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('conjugationPracticeState');
                if (savedState) {
                    const loadedState = JSON.parse(savedState);
                    state.currentTopic = loadedState.currentTopic;
                    state.correctCount = loadedState.correctCount;
                    state.incorrectCount = loadedState.incorrectCount;
                    state.learningQueue = loadedState.learningQueue;
                    state.typedRomajiBuffer = loadedState.typedRomajiBuffer || ""; 
                    state.currentMode = loadedState.currentMode || "introduction"; // Load mode, default to intro
                }
                dom.topicSelect.value = state.currentTopic;
                updateCounts();
            };

            const displayIntroductionUI = () => {
                // Hide practice elements
                dom.cardPanel.classList.add('hidden');
                dom.answerInput.classList.add('hidden');
                dom.checkButton.classList.add('hidden');
                dom.nextButton.classList.add('hidden');
                dom.feedbackArea.classList.add('hidden');
                dom.progressArea.classList.add('hidden');

                // Show introduction elements
                dom.introPanel.classList.remove('hidden');
                dom.startPracticeButton.classList.remove('hidden');
                dom.introSectionsContainer.innerHTML = ''; // Clear previous sections

                const introContentForForm = formIntroContent[state.currentTopic];
                if (introContentForForm) {
                    dom.introTitle.textContent = introContentForForm.title;
                    introContentForForm.sections.forEach(section => {
                        const sectionDiv = document.createElement('div');
                        if (section.heading) {
                            const h3 = document.createElement('h3');
                            h3.textContent = section.heading;
                            sectionDiv.appendChild(h3);
                        }
                        // Handle content with newlines and bullet points
                        const contentParts = section.content.split('\n');
                        let currentUl = null;
                        contentParts.forEach(line => {
                            if (line.startsWith('•  ')) {
                                if (!currentUl) {
                                    currentUl = document.createElement('ul');
                                    sectionDiv.appendChild(currentUl);
                                }
                                const li = document.createElement('li');
                                li.innerHTML = line.substring(3).trim().replace(/\n/g, '<br>'); // Remove bullet, add breaks
                                currentUl.appendChild(li);
                            } else {
                                currentUl = null; // Reset if not a bullet
                                const p = document.createElement('p');
                                p.innerHTML = line.trim().replace(/\n/g, '<br>');
                                sectionDiv.appendChild(p);
                            }
                        });
                        dom.introSectionsContainer.appendChild(sectionDiv);
                    });
                } else {
                    dom.introTitle.textContent = "Introduction";
                    const p = document.createElement('p');
                    p.textContent = "No introduction available for this topic.";
                    dom.introSectionsContainer.appendChild(p);
                }
            };

            const displayPracticeUI = () => {
                // Hide introduction elements
                dom.introPanel.classList.add('hidden');
                dom.startPracticeButton.classList.add('hidden');

                // Show practice elements
                dom.cardPanel.classList.remove('hidden');
                dom.answerInput.classList.remove('hidden');
                dom.checkButton.classList.remove('hidden'); // Initially show check button
                dom.feedbackArea.classList.remove('hidden');
                dom.progressArea.classList.remove('hidden');

                // Reset input and feedback for a new card
                state.typedRomajiBuffer = "";
                dom.answerInput.value = '';
                dom.feedbackMessage.textContent = '';
                dom.correctAnswerDisplay.textContent = '';
                dom.answerInput.classList.remove('correct', 'incorrect');
                dom.answerInput.focus();
            };

            const generateNewPracticeSession = () => {
                state.correctCount = 0;
                state.incorrectCount = 0;
                state.learningQueue = [];
                state.currentCard = null; // Clear current card
                state.typedRomajiBuffer = "";
                dom.answerInput.value = '';

                // Filter based on the selected individual form key
                const selectedFormKey = state.currentTopic; 

                // Add relevant verbs
                japaneseVerbs.forEach(verb => {
                    if (verb.conjugations[selectedFormKey]) {
                        state.learningQueue.push({ item: verb, formKey: selectedFormKey });
                    }
                });

                // Add relevant adjectives
                japaneseAdjectives.forEach(adjective => {
                    if (adjective.conjugations[selectedFormKey]) {
                        state.learningQueue.push({ item: adjective, formKey: selectedFormKey });
                    }
                });
                
                state.learningQueue = state.learningQueue.sort(() => Math.random() - 0.5); // Shuffle
            };

            const displayNextCard = () => {
                displayPracticeUI(); // Ensure practice UI is shown

                if (state.learningQueue.length === 0) {
                    // All questions for this topic have been presented
                    dom.kanaDisplay.textContent = "お疲れ様でした！"; // O-tsukaresama deshita!
                    dom.kanjiDisplay.textContent = "(Well done! You've completed this topic.)";
                    dom.formDisplay.textContent = "Reset the session or choose another topic to continue.";
                    dom.verbTypeDisplay.textContent = "";
                    dom.checkButton.classList.add('hidden');
                    dom.nextButton.classList.add('hidden'); // No next card
                    return;
                }

                state.currentCard = state.learningQueue.shift(); // Get next card from queue
                const { item, formKey } = state.currentCard;
                const formDisplay = conjugationForms.find(f => f.key === formKey).display;

                dom.kanaDisplay.textContent = item.kana;
                dom.kanjiDisplay.textContent = `(${item.word} - ${item.meaning})`;
                dom.formDisplay.textContent = `Conjugate to: ${formDisplay}`;
                dom.verbTypeDisplay.textContent = item.type;

                updateCounts();
                saveState();
            };

            const checkAnswer = () => {
                if (!state.currentCard) return;

                // The answer check should use the *converted* Romaji from the input field
                const userAnswerHiragana = dom.answerInput.value.trim();
                const correctAnswerHiragana = state.currentCard.item.conjugations[state.currentCard.formKey];

                if (userAnswerHiragana === correctAnswerHiragana) {
                    dom.feedbackMessage.textContent = "Correct!";
                    dom.feedbackMessage.className = 'correct';
                    dom.answerInput.classList.add('correct');
                    state.correctCount++;
                    // If correct, put it back at the end of the queue for spaced repetition later
                    state.learningQueue.push(state.currentCard);
                } else {
                    dom.feedbackMessage.textContent = "Incorrect";
                    dom.feedbackMessage.className = 'incorrect';
                    dom.answerInput.classList.add('incorrect');
                    dom.correctAnswerDisplay.textContent = `Correct: ${correctAnswerHiragana}`;
                    state.incorrectCount++;
                    // If incorrect, re-insert closer to the front for more immediate re-practice
                    state.learningQueue.splice(Math.min(3, state.learningQueue.length), 0, state.currentCard);
                }

                updateCounts();
                saveState();
                dom.checkButton.classList.add('hidden');
                dom.nextButton.classList.remove('hidden');
            };

            // --- EVENT LISTENERS ---
            dom.checkButton.addEventListener('click', checkAnswer);
            dom.nextButton.addEventListener('click', displayNextCard);
            dom.startPracticeButton.addEventListener('click', () => {
                state.currentMode = 'practice';
                generateNewPracticeSession(); // Generate new session questions
                displayNextCard(); // Display the first question
            });

            // Listener for actual key presses to manage the Romaji buffer
            dom.answerInput.addEventListener('keydown', (e) => {
                // Only process keydown if in practice mode and not hidden
                if (state.currentMode !== 'practice' || dom.answerInput.classList.contains('hidden')) return;

                e.preventDefault(); // Prevent default browser input behavior

                const key = e.key;
                let updateDisplay = true;

                if (key.length === 1 && key.match(/^[a-z0-9\s]$/i)) { // Alphanumeric and space characters
                    state.typedRomajiBuffer += key.toLowerCase();
                } else if (key === 'Backspace') {
                    if (state.typedRomajiBuffer.length > 0) {
                        state.typedRomajiBuffer = state.typedRomajiBuffer.slice(0, -1);
                    }
                } else if (key === 'Enter') {
                    if (!dom.checkButton.classList.contains('hidden')) {
                        checkAnswer();
                    } else if (!dom.nextButton.classList.contains('hidden')) {
                        displayNextCard();
                    }
                    // After check/next, the buffer should be cleared for the next card
                    state.typedRomajiBuffer = "";
                    updateDisplay = false; // Display will be updated by displayNextCard
                } else {
                    updateDisplay = false; // Do not update display for other keys (shift, ctrl, arrows etc.)
                }

                if (updateDisplay) {
                    const displayValue = convertRomajiToHiragana(state.typedRomajiBuffer);
                    dom.answerInput.value = displayValue;
                    // Keep cursor at the end for smooth typing.
                    dom.answerInput.setSelectionRange(displayValue.length, displayValue.length);
                }
            });

            dom.topicSelect.addEventListener('change', (e) => {
                state.currentTopic = e.target.value;
                state.currentMode = 'introduction'; // Always go to intro when topic changes
                generateNewPracticeSession(); // Generate queue, but don't display yet
                displayIntroductionUI(); // Show intro UI
                updateCounts(); // Reset counts visually
                saveState();
            });

            dom.resetButton.addEventListener('click', () => {
                // IMPORTANT: Do NOT use confirm() in production code. Use a custom modal instead.
                // For this exercise, it's kept as per previous implementation but noted.
                if (window.confirm('Are you sure you want to reset your progress for this topic and return to the introduction?')) {
                    state.currentMode = 'introduction';
                    generateNewPracticeSession(); // Clear existing queue and counts for current topic
                    displayIntroductionUI();
                    updateCounts(); // Reset counts visually
                    saveState();
                }
            });

            // --- INITIALIZATION ---
            // Populate the topic select dropdown
            const populateTopicSelect = () => {
                dom.topicSelect.innerHTML = ''; // Clear existing options
                // Group verb forms
                const verbOptgroup = document.createElement('optgroup');
                verbOptgroup.label = 'Verbs';
                conjugationForms.filter(f => !f.key.startsWith('iAdjective') && !f.key.startsWith('naAdjective')).forEach(form => {
                    const option = document.createElement('option');
                    option.value = form.key;
                    option.textContent = form.display;
                    verbOptgroup.appendChild(option);
                });
                dom.topicSelect.appendChild(verbOptgroup);

                // Group adjective forms
                const adjectiveOptgroup = document.createElement('optgroup');
                adjectiveOptgroup.label = 'Adjectives';
                conjugationForms.filter(f => f.key.startsWith('iAdjective') || f.key.startsWith('naAdjective')).forEach(form => {
                    const option = document.createElement('option');
                    option.value = form.key;
                    option.textContent = form.display;
                    adjectiveOptgroup.appendChild(option);
                });
                dom.topicSelect.appendChild(adjectiveOptgroup);
            };

            populateTopicSelect();
            loadState(); // Load state after populating dropdown to set selected value

            // Decide initial display based on loaded state
            if (state.currentMode === 'practice' && state.learningQueue.length > 0 && state.currentCard) {
                displayPracticeUI();
                // If a card was saved, display it directly
                const { item, formKey } = state.currentCard;
                const formDisplay = conjugationForms.find(f => f.key === formKey).display;
                dom.kanaDisplay.textContent = item.kana;
                dom.kanjiDisplay.textContent = `(${item.word} - ${item.meaning})`;
                dom.formDisplay.textContent = `Conjugate to: ${formDisplay}`;
                dom.verbTypeDisplay.textContent = item.type;
                dom.checkButton.classList.remove('hidden'); // Ensure check button is visible for existing card
                dom.nextButton.classList.add('hidden'); // Hide next button until checked
            } else {
                state.currentMode = 'introduction'; // Ensure we start in intro if no active session
                generateNewPracticeSession(); // Pre-populate queue for first-time topic load
                displayIntroductionUI();
            }
        });
    </script>
</body>
</html>
